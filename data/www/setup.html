<!doctype html>
<html>
<head>
    <title>Controle de Rotor PU3IKE</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <meta charset="UTF-8">
</head>
<body>
<div class="border border-primary m-5 bg-white rounded" style="width:500px;" >
    <div class="row m-1" >
        <div class="col-6 text-center">
            <div id="Rssi"></div> 
        </div>
    </div>    
    <div class="row m-1" >
        <div class="col-6 text-center">
            <div id="ADCValue"></div> 
        </div>
    </div>
    <hr>
    <div class="row m-1">
        <div class="col text-center"><strong>Network Settings</strong></div>
    </div>
    <div class="row m-1">
        <div class="col-12 text-center">
            Hostname:<input type="text" size=20 id="hostname"/>
        </div>
    </div>
    <hr>
    <div class="row m-1">
        <div class="col text-center"><strong>General Settings</strong></div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Motor Type:
            <select id="motor_type">
                <option value="0">AC</option>
                <option value="1">DC</option>
            </select>
        </div>
        <div class="col-6 text-center">
            Analog Pin:<input type="text" size=4 id="analogPin"/>
        </div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            ADC Interval (us):<input type="text" size=8 id="adcReadInterval"/>
        </div>
        <div class="col-6 text-center">
            Filter (0.0-1.0):<input type="text" size=4 id="alphaFilter"/>
        </div>
    </div>
    <hr>
    <div class="row m-1">
        <div class="col text-center"><strong>Calibration Table</strong></div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Az 0:<input type="text" size=6 id="Az0" value=""/>
        </div>
        <div class="col-6 text-center">
            ADC Val0:<input type="text" size=6 id="ADCValue0"/>
        </div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Az 1:<input type="text" size=6 id="Az1" value=""/>
        </div>
        <div class="col-6 text-center">
            ADC Val1:<input type="text" size=6 id="ADCValue1"/>
        </div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Az 2:<input type="text" size=6 id="Az2" value=""/>
        </div>
        <div class="col-6 text-center">
            ADC Val2:<input type="text" size=6 id="ADCValue2"/>
        </div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Az 3:<input type="text" size=6 id="Az3" value="" />
        </div>
        <div class="col-6 text-center">
            ADC Val3:<input type="text" size=6 id="ADCValue3"/>
        </div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Az 4:<input type="text" size=6 id="Az4" value="" />
        </div>
        <div class="col-6 text-center">
            ADC Val4:<input type="text" size=6 id="ADCValue4"/>
        </div>
    </div>
    <div class="row m-1" >
        <div class="col-6 text-center">
            Az 5:<input type="text" size=6 id="Az5" value="" />
        </div>
        <div class="col-6 text-center">
            ADC Val5:<input type="text" size=6 id="ADCValue5"/>
        </div>
    </div>
    <div class="row m-1">
        <div class="col m-4 text-center">
            <button type="button" class="btn btn-primary" id="Save" >Save</button>
        </div>
    </div>
</div>
<script>
    var compassSocket;
    function connect() {
        
        compassSocket = new WebSocket("ws://" + location.host + "/compass");
        
        compassSocket.onmessage = function(event){
            var msg = JSON.parse(event.data);
            //if( Math.abs(compass_gauge.value - msg) >= 3 ) compass_gauge.value = msg;
            console.log(msg);

            // Type 0 = Status
            if(msg["type"] == 0){
                // Check for each key before updating the HTML
                if (msg.hasOwnProperty("adc_value")) {
                    $("#ADCValue").html("ADC Value:" + msg["adc_value"]);
                }
                if (msg.hasOwnProperty("rssi")) {
                    $("#Rssi").html("Wifi Rssi: " + msg["rssi"]);
                }
            }else if(msg["type"] == 1){
                for (let i = 0; i < 6; i++) {
                    $("#Az" + i).val(msg["Az" + i]);
                    $("#ADCValue" + i).val(msg["ADCValue" + i]);
                }
                // Populate new fields
                $("#motor_type").val(msg["motor_type"]);
                $("#analogPin").val(msg["analogPin"]);
                $("#adcReadInterval").val(msg["adcReadInterval"]);
                $("#alphaFilter").val(msg["alphaFilter"]);
                $("#hostname").val(msg["hostname"]);
            }
        };

         // Type 0 = Commands
         // Type 1 = Get config
         // Type 2 = Set Config

        // When the socket is opened, request the current configuration
        compassSocket.onopen = function(e) {
            
            start_Json = { 'type':'1' } 
            compassSocket.send(JSON.stringify(start_Json));

        };

        compassSocket.onclose = function(e) {
            console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
                setTimeout(function() {
                connect();
                }, 1000);
        };
    }
    
    connect();
    
    
    $(document).ready(function() {
        $('#Save').on('click',function (e) {

            var conf_Json = { 
                'type':'2' // Set type as AD X Angle config
            };

            for (let i = 0; i < 6; i++) {
                conf_Json['Az' + i] = $("#Az" + i).val();
                conf_Json['ADCValue' + i] = $("#ADCValue" + i).val();
            }

            // Add new config values to JSON
            conf_Json['motor_type'] = $("#motor_type").val();
            conf_Json['analogPin'] = $("#analogPin").val();
            conf_Json['adcReadInterval'] = $("#adcReadInterval").val();
            conf_Json['alphaFilter'] = $("#alphaFilter").val();
            conf_Json['hostname'] = $("#hostname").val();

            if (compassSocket.readyState === WebSocket.OPEN) {
                compassSocket.send(JSON.stringify(conf_Json));
                alert("Configuration saved!");
            }
            
        });
    
    });
    </script>

</body>
</html>
